
// Implementation of the MiMC^P permutation in Feistel mode (MiMC-2p/p)

function sbox(state: field, constant: field) -> field {
    let c: field = state + constant;

    let c2: field = c*c;
    let c4: field = c2*c2;
    let c8: field = c4*c4;
    let c11: field = c8*c2*c;

    return c11;
}

function round(state: [field; 2], constant:field) -> [field; 2] {
    state[1] += sbox(state[0], constant);
    return state;
}

function permutation(state: [field; 2]) -> [field; 2] {

    const N_ROUNDS:u32 = 147;

    let RC: [field; 147] = [
            3865702934124093755943890899496595264675194361091768380145853932420267718340,
            1007157542023399026163733618843871954165432315393358131261818260851607860762,
            4405765946538921025695035439523237362153599324827654321243952925829102897068,
            3664456287923997818199382200327273463939055455139573605615804006507349414661,
            2479489572468184036834185846792232691704338102259969479698246638387375208601,
            7075648328350487201312983428164658511683774052982117667454064553426505353162,
            2960294807379567246253984953057914668745462822263982506749542777126037825529,
            2655812495393928857516360458189928747555423217713187454417839156697050815551,
            3717213111525477182308086593270061421437666548113911929620301980108517642466,
            5897808706471742820665820095022518011386522049976073844253979668351877466312,
            2569787039743718035787724902663735194730802589523124340571161869727725482097,
            1917595914613084001604147506045907028827939266576412756959438159796077576451,
            2114046517699391618348286057669531710807085963712748725191291057404732278115,
            644259177467713838783902939864801110108813136167721986975094107705582352533,
            114909232591356514258848502900301940916780568920730669731705709008731267821,
            397670186510146228006808036460694845855648534747458892489666599345186868099,
            14115845680006648591497015219873595226115034158016006492243495181700020328,
            7473725578839950432056456200416590972132303487896037525173551404376079662608,
            6851698320087679137871067907621292228396364195185452632489577925471054952612,
            3526452007006766063291580410817421711469621856243969892829343794210647677088,
            561761156586415725812411621756746409172193544396702757822491241047888301314,
            5978809527945747095659426624230992834899031378497238603161042133194822414274,
            7643599905028297699920578033606962073430285525924748161592769566794919374519,
            8165997167929763248247852649928827290148430676566758952864942625508983634174,
            7358945185442998780990254609963058331795852198306645434353892647398025598777,
            1175776223385596679609660800890726253966400708669112455937709732921704773012,
            3263598843683222799677493234805311323455843044964126094692940429070636645114,
            1440060990374802498918976909398759124881579259216178206712400427992920710397,
            563691042074148608722818033326650316201714990967380252936522866156849413991,
            6069389034748838796665965087406127401125767020568102631897762789542994701644,
            7348347499454276385135101496097238108638109417027990495050252952137070050563,
            6137077295063883416001673633303947076361172027796306946873522218476536029965,
            4282501080204693776175485316408037887010801176943906373585505276121728049998,
            1827594512643843810145127850734690943167240881096013666657718824011828977488,
            821608683322885118742346116029606917461059212692024300580775629332822227465,
            3566438080554791697752468409803297678301449523645026086385296970078699884477,
            7346172536699229604549085232388212237337059364540558727745855718123513858916,
            4003629880635114962321543207848485639256591474046764154146405069192099538783,
            8444118066294681057518200421416516128364891299606756969545568468358114044979,
            847133853572289193754144737185386942147741360102441150209009136878800748405,
            3610427416683698951715364427340546755244328102923123077708303165596467432784,
            517983548542976056344456890078332531821447617752560687977234729587737933342,
            6622323143386024736336391707005930078318105370333811709321121792438190740643,
            4424280377242259224928553131044155477605600599182901812482727531425529098896,
            5261781906347939656847922563017535330163586273291464183598486117074404855391,
            5310856547479116579620917806521589963437265732967740492586268482658006640076,
            5964602724054242261234051025028640529293583047252408099485609998238354988627,
            3328186457915990239502811796792981661039821308874445285216059577893461977096,
            4693950311730228131153738168059288512040022709945203082317646752231584144748,
            3659924578416166584937707964675707323546538621984642087605256165271489802192,
            858773571599438733025221924245768174770535622663708444211341838920387098322,
            5648897124823481951198584158924938496063485824712486769231894070714413632659,
            5291695581135311517384701767680348466176745776485102181089201513650134077986,
            5210056831745039316751708353413061992794024239970225444575230610207434308761,
            4931493414312043090846473003389103786327020131130420236686438425611741953266,
            7417915536247499538669471816776035303699312710315080241598056280051801275606,
            5817886269275215376288925709339870819235571504283742416944845082372207938977,
            1539347685628443521273005225790481275648513380758921481545007407541383553149,
            6083104230561727246622182932817911265406404482767809798118244933416968781726,
            4791213460228492117042137577047209262404628134206682631190988329878143414607,
            7851994110538136277820927704510377034447285151536609812350302980948743112650,
            6675266407058851429339413933203039204993873039570805818023356894872015771918,
            3645782646084613400857261616354090133867808938672310908717999043262608356629,
            4741494231432225722018475454488346410339234415710423635930147781563388780557,
            4132942712644011489214110979165759483933319574629591407902611543312459103148,
            946488428809801895534323798708844901197132573813561800249865753200190925761,
            1946387756104909212041952255292803925700298714456016378717890471916473255683,
            2874204111446030257932708610362065353200100714379943498442667343524437243155,
            2885825207249884304019439021719304072999791364997710645829890548569915601540,
            3771333502881247071542287039760680469527256450631689540913573090827914329502,
            6271505412803776478276013417287574958782664363780470844563942142319861205996,
            3931070949981680296457729444285570941750177962296676379723544786325786355686,
            7939706351158660360750661672177491800675051261455166901643071878390646503976,
            6164019342609507668318772071346429556317462496136192055261065451039379997828,
            6859050652926107666954728399121954403873173470871302392484325359412105832974,
            1468280283972157606242264482336782135265422593584085638632784107534831609886,
            6089459933959324733802482673764556470388449773148370488292513554371048437523,
            4096767335304342899625025274023952371881826478537928433504120350731475922280,
            3174971596048882095137935134721054940783319375504525895179831080063507291197,
            5149096466813691980734766910614784649500943768831574416373792049074502808216,
            2452163502053935772076010740963483127204234270750000955417518391914313236295,
            1511257921602154276959486795356547289454919627187724590526318319354227041507,
            6165380109282616674437552820034048333423439197651822920690560629710624356117,
            7325324803799452110764935962449518689459950249701596503088604110194308608703,
            1744426299978203492133307868417345550478845632280183092352530528505034578771,
            6906715758271933376448869212009087191249244922663968629886659793662774504241,
            6556262994491231977291503957384039887917874771571926099675921030966839001832,
            7899051035275098572945475152493523695837082198551302487437927029445222172105,
            4054326089502370528204360566661561772487998602592268480804719582474860095491,
            4761884969271015400090404991504215688203661282584213990006367799825059777759,
            5898339603617715493301148786053914182425297247537728364599572609332073353698,
            4941505828736765445418553399859453326718559536450895872909161729819911326731,
            4138320831574473231983124857973714650597253513365552782646101325811670955210,
            7827069941350735389658047682310229501882080707414307244698641563573245404841,
            6881239132893879840904818380960465514474778697110621884671452713304779884743,
            3360810560808591756582532402038677834188750401133317110500736508487615110196,
            471749919592666472329775092130040097064695005852718021404905497332665834252,
            6229509597671576102507751935366090173176188544277174781554949506624691638860,
            7035840324355860906351859310859858747549592634026239790140910374752132452074,
            7719733688526768892811564260628512296806869819603859113665379788505446519853,
            4502788126974176207579435266403185649695007828064517542424121278398713487614,
            4439733682278990081685216181833881800867379377335383856878250267597369309760,
            4237749056756013800261916330944894922562967292660884981739306928588731712654,
            520182133572288411923265884988409832423868025423978214296796287053446122247,
            4430117845578463074068872148007826383701735806096743927492658281719991313920,
            5224359053019891046692328288404570627281524161733201241572390981069199377320,
            5359100687164014056682974919326790542753871150080580049992622743883714309040,
            4417106749180798266725529101627128467041425585216217680474884831408540605170,
            5008302024166368010492591015628189493741168282861940304907437703919647698096,
            2511533446887354157542109880995347802161539142316995065365850861726823711754,
            3523476875169242512138419311796857692493246527259948303401937814553927461856,
            8386102034436222944003676201027306176404993281408573067013034465691899872111,
            2943824961239774820406922515312255183415536180610481677341625833413317141342,
            4291012187584370146965980073426755660105096488195171039417742781753840798077,
            1774417308292575212785632115758563276054788704209189277638237533942451036583,
            5460286387676186202545923410123453573793029945852385382007506441127746475263,
            3138158823593534566597440337232218752848523161142454612043450966876670093247,
            4500896808391617708646307235336166957065485105533728951670120276020105901908,
            3042435552350292133393715714356966546853546320122118619666907631585533787464,
            6977210854168055787545413500494103730823674679092286394748833476135526036917,
            5059123314230624672606633167634298216929034779041046161065994412900760271897,
            4336841320603670311630340473425532558128157266892408183382498839445932503725,
            6851241344738433711699928486207288575535316908136629648459247271574465337327,
            1570259837393468601031333668965712088324518431641815715079781332813355573795,
            3556413647869368560602478653411419373529457871200946441350648457147674246572,
            1406977640049671162284764288670818470421149262270359652846766016339635983518,
            1365689375970803440802927873753547209540903528329841281871520900450719818340,
            6206792226395521658584078715766842885660930595236192695180129405919951783840,
            259611954918060946649902968976232814483927731469138324747446317793144193365,
            4453768309007742308159489466244998904192530293831882937400304683055576281904,
            110043673957032692043889180423809139793712505212622714286115820203024317193,
            7940475073149674705545789241907627620270273800279720898012598350714582112934,
            1040869992833848565322297059589106578100125892169402045486800990354050573993,
            1621753264713902330419384565789208189915281489155215494195083314248347667258,
            2283756100202512669150162146793520220379008624041668413006334116318405371828,
            2347889021419810796413405081103637443143497804112149026158989568431847379086,
            4998318912005075716391807304039433415112186632076783581146242734076460729588,
            7855034372631208890720309258371919293900024857437571219080798281368423923171,
            7120950015131940590624993031822933220623136801637222267602749032729601288749,
            7734399649137472037345318115651481724370471402301573579800886790247322173029,
            456419424329056439351223821992018218116690129821033366144087917727266014410,
            476295725561352185571943905279177748027374270012905745647427395088375064868,
            5943928848779486925441395077146413864173255127001087220085381147547751487102,
            8027655478138890119234791829974906864588587577160023268582063050012954655197,
            7687545491407243578138660792989370259027838962927279562322213575702987063508,
            2451213134393050748543948851152376718172767280514938365722591982983351314757,
            3050403803364258138757408027041392469872319878968856847031171587886782381210
        ];

        let tmp: field = 0field;

        for i in 0..N_ROUNDS - 1{
        
            state = round(state, RC[i]);
            tmp = state[0];
            state[0] = state[1];
            state[1] = tmp;
        }

        state = round(state, RC[N_ROUNDS - 1]);

        return state;

}

function main(a: [field; 2]) -> [field; 2] {

    let m: [field; 2] = [0field, 0field];

    m =  permutation(a);
    return m;
   

}

@test
function sbox_test() {
    let constant: field = 5943928848779486925441395077146413864173255127001087220085381147547751487102 ; 
    let state: field = 5324319209727394843353330183529117967230803372202482264714325483223508628524 ;
    let check: field = 4817246075678656562069386914259487599241369120264717506466034175518663577036  ;
    let result = sbox(state, constant);

    console.assert(check == result);
}

@test
function round_test() {
    let state_in: [field; 2] = [
        205590015168576069906775328287417415487799853627397567932093125904979123828,
        6314658282813217945138278251984680094319698463151078319831502705046804707990 
    ];

    let constant: field = 7687545491407243578138660792989370259027838962927279562322213575702987063508;
    

    let result_0: field = 205590015168576069906775328287417415487799853627397567932093125904979123828;
    let result_1: field = 4768980667092361968239023698012060630723900845915064763583717922931253545522;

    let result = round(state_in, constant);

    console.assert(result_0 == result[0]);
    console.assert(result_1 == result[1]);
}

@test() 
function permutation_test() {

    let result_0:field = 3923519758376222111339619778895656095136749476144248239147210085431750219636; 
    let result_1:field = 625857176239097408130409716354562276583171201576558297609603657594670053879;

    let input_0: [field; 2] = [
        984200713089513605154218542917638027410011887014200711769621013628049470701,
        8149018503654110547125721475820495338768397646474390446356229051347711607835
    ];

    let r = permutation(input_0);

    console.assert(result_0 == r[0]);
    console.assert(result_1 == r[1]);
}

